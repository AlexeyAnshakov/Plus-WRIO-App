<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<template id="plus-plus-template">
    <li class="new panel active"><a href="#element4" data-parent="#nav-accordion" data-toggle="collapse">
        <span class="glyphicon glyphicon-plus"></span></a>
        <div class="collapse" id="element4"></div>
    </li>
</template>

<script>
    (function ($) {
        var webrunes = window.webrunes || {};

        // incoming data (jsonLd)
        //var model = webrunes.jsonlds['ItemList'];
        var model =     {
            "@context": "http://schema.org",
            "@type": ["ItemList", "CreativeWork"],
            "name": "My Plus List",
            "itemListElement": [
                {
                    "@type": "Article",
                    "inLanguage": "en-US",
                    "author": "http://webrunes.github.io/webRunes-WRIO-Hub/Alexey-Anshakov.html",
                    "name": "The story of the cat",
                    "about": "Description text",
                    "image": "http://domain1.com/image1.jpg",
                    "url": "http://wall2003.github.io/webRunes-WRIO-Hub/The-story-of-the-cat.html"
                },
                {
                    "@type": "Article",
                    "inLanguage": "en-US",
                    "name": "Alexey Anshakov",
                    "about": "Description text",
                    "image": "http://domain.com/image.jpg",
                    "url": "http://wall2003.github.io/webRunes-WRIO-Hub/article.htm"
                },
                {
                    "@type": "Article",
                    "inLanguage": "en-US",
                    "name": "Abother hub",
                    "about": "Description text",
                    "image": "http://domain-another-hub.com/image.jpg",
                    "url": "http://domain.com/article.htm"
                },
                {
                    "@type": "Article",
                    "inLanguage": "en-US",
                    "author": "http://webrunes.github.io/webRunes-WRIO-Hub/Alexey-Anshakov.html",
                    "name": "Help post",
                    "about": "Description text",
                    "image": "http://domain2.com/image2.jpg",
                    "url": "http://domai.com/article2.htm"
                },
                {
                    "@type": "Article",
                    "inLanguage": "en-US",
                    "author": "http://domain-another-hub.com/url-another-hub.html",
                    "name": "Article",
                    "about": "Description text",
                    "image": "http://domain3.com/image3.jpg",
                    "url": "http://domain.com/article3.htm"
                }
            ]
        };

        var importDoc = document.currentScript.ownerDocument;

        // pulse tab-menu wrapper
        var $accordion = $(importDoc.querySelector('#plus-accordion-template').innerHTML);

        // sign '+' markup
        var $plus = $(importDoc.querySelector('#plus-plus-template').innerHTML);

        // browser address url
        var href = window.location.origin + window.location.pathname;

        var plusWidget = Object.create(HTMLElement.prototype);

        // call after custom-tag rendered
        plusWidget.createdCallback = function () {
            plusWidget.drawPulseTabs();
        };
        plusWidget.drawPulseTabs = function(){
            var groupedModel = plusWidget.groupByAthour(model);

            // draw pulse Tabs
            for(var i = 0; i < groupedModel.length; i++){
                // check if Tab's url same with browser's, if yes - make active
                var collapseCss = groupedModel[i].url == href ? '' : 'collapsed';
                var activeCss = groupedModel[i].url == href ? 'active' : '';

                var $parentTab = $('<li/>', { class: 'panel ' + activeCss});
                var $parentTabTitle = $('<a href="#" data-parent="#nav-accordion" data-toggle="collapse"></a>',{ href: '#element' + (i + 1), class: collapseCss })
                        .html(groupedModel[i].name);

                $parentTab.append($parentTabTitle);

                if(groupedModel[i].items.length > 0){
                    var $childTabsWrapper = $('<ul class="nav nav-pills nav-stacked sub"></ul>');

                    // draw children tab below main authorTab
                    for(var j = 0; j < groupedModel[i].items.length; j++){
                        var $childTab = $('<li><a href="#" class="pull-right"><span class="glyphicon glyphicon-remove"></span></a></li>');
                        var $childTabTitle = $('<a href="#"></a>', { href: model[i].items[j].url}).html(model[i].items[j].name);

                        $childTab.append($childTabTitle);
                        $childTabsWrapper.append($childTab);
                    }

                    var $div = $('<div/>', { id: 'element' + (i + 1), class: groupedModel[i].url == href ? 'active' : 'collapse'})
                            .append($childTabsWrapper);
                    $parentTab.append($div);
                }
                $accordion.append($parentTab);
            }

            $accordion.append($($plus));
            this.outerHTML = $($accordion).get(0).outerHTML;
        };
        plusWidget.groupByAthour = function(loModel){
            if(!loModel) return [];
            var models = [];
            for(var i = 0; i < loModel.itemListElement.length; i++){
                if(!loModel.itemListElement[i].author){
                    var blogUrl = loModel.itemListElement[i].url;
                    var item = {name: loModel.itemListElement[i].name, url: loModel.itemListElement[i].url, items: []};
                    for(var j = 0; j < loModel.itemListElement.length; j++){
                        if(loModel.itemListElement[j].author && loModel.itemListElement[j].author == blogUrl){
                            var elem = {name: loModel.itemListElement[j].name, url: loModel.itemListElement[j].url};
                            item.items.push(elem);
                        }
                    }
                    models.push(item);
                }
            }
            return models;
        };
        document.registerElement('plus-widget', { prototype: plusWidget });
    })(jQuery);
</script>